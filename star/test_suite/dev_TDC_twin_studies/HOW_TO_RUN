

edit inlist_for_test_header to select a case

NOTE: starting models must be created with 
  use_gradT_actual_vs_gradT_MLT_for_T_gradient_eqn = .true.
  set_rho_to_dm_div_dV = .false.
  mlt_make_surface_no_mixing = .true.

  inlist should set mixing_length_alpha



















-------------------------------

RECORD THE ZOOM


there are currently 3 test cases for TDC
   dev_TDC_RSP - comparison to RSP test cases
   dev_TDC_twin_studies - comparison to early pre ms while still convective core
   dev_TDC_solar_twin_studies - comparison to simplex_solar_calibration starting model

all are "twin studies" that run two models in synch using pgstar to show comparisons

for this discussion, we'll focus on dev_TDC_twin_studies

do this on your machine:
cd star/test_suite/dev_TDC_twin_studies
clean;mk;rn
   this is a "still convective to center" pre-ms 1Msun model.
   mostly great agreement, expect higher Teff and L for the tdc run.  why?  don't know.
   star2 starts getting retries because residuals too large.  why?  don't know.
   lots to be done!

the "twin studies" start by loading the same model into each run.
"star1" is the standard (rsp or mlt) twin.   "star2" is the tdc one.

in src/run.f90 you'll find "call do_run_multi_stars" 
   the code for that lives in star/job/multi_stars_extras.inc with controls in multi_star_extras_def.inc

open inlist_multi_stars_job and take a look.
   num_stars = 2
   inlist_names for the star headers
   restart info and other misc

the headers for star1 and star2 have exactly the same structure.  open inlist_star1_header
   for each section it has
      inlist_for_test_header
      inlist_common
      inlist_star1

open inlist_for_test_header.   it is setup to read inlist_pre_ms_with_convective_core.
   in dev_TDC_solar_twin_studies, the test_head reads inlist_solar. 

open inlist_pre_ms_with_convective_core
   this is a slightly edited copy of the inlist that was used to create the starting model for the twin tests.
   creating starting models for dev_TDC_RSP is easy - just run rsp and save a model after 50 steps or so.
   but creating starting models for TDC vs MLT comparisons is a bit trickier for TDC compatibility.      
   
      mlt_make_surface_no_mixing = .true.    this one is trivial but important since TDC enforces this
      use_gradT_actual_vs_gradT_MLT_for_T_gradient_eqn = .true.     this one is non-trivial.
         i've added a new option for the temperature equation that gives a better match to TDC.  (more later on this)
   
open inlist_common
   for now, we have remesh off so that we can do cell-by-cell comparisons for the two runs
      okay_to_remesh = .false.
   it isn't necessary, but if you want to force the same timesteps, set force_timestep
   the &pgstar section has History_Panels1 and Profile_Panels1 with plots showing both twins
      history items v_1, r_1, Teff_1, L_1 are for star1 and are written by star2 run_star_extras.
      same for profile items v_kms_1, lgcv2_1, spr_ad_1, etc.
      note "debugging output" xtra1, xtra1_1, xtra2, xtra2_1, etc. 
         these show plots based on xtra1_array, xtra2_array, etc from star1 and star2
         fantastic debugging tool!

open inlist_star1 -- pretty trivial.  sets photo and log directories.

open inlist_star2
   change over to tdc and turn on v_flag
   set TDC parameters.   some values are different for comparisons to RSP vs comparisons to MLT.
   set solver parameters.  delay gold2 tolerances for 10 steps.   a few more TDC related controls.
   star2 owns the pgstar plots.  see &pgstar section.   use Profile_Panels_xmin/max to focus in on problem spots.
   
debugging example - check the terms going into Lr for tdc vs Lrad for mlt.
   open hydro_tdc.f90 and search for "xtra1_array" in function compute_Lr
      uncomment the assignments to the xtra arrays.
   open hydro_eqns.f90 and add similar assignments in subroutine do1_gradT_eqn
      take a moment to read that eqn - fantastic!
         open auto_diff_support and check the various "wrap" routines
         open star_utils and check save_eqn_residual_info
      add this at the end of do1_gradT_eqn
   
         call set_xtras
      
         contains
   
         subroutine set_xtras
            use auto_diff_support
            use star_utils, only: get_Lrad
            type(auto_diff_real_star_order1) :: &
               T4m1, T400, kap_m1, kap_00, alfa, beta, kap_face, &
               diff_T4_div_kap
            T4m1 = pow4(wrap_T_m1(s,k))
            T400 = pow4(wrap_T_00(s,k))
            kap_m1 = wrap_kap_m1(s,k)
            kap_00 = wrap_kap_00(s,k)
            alfa = s% dq(k-1)/(s% dq(k-1) + s% dq(k))
            beta = 1d0 - alfa
            kap_face = alfa*kap_00 + beta*kap_m1
            diff_T4_div_kap = (T4m1 - T400)/kap_face
            s% xtra1_array(k) = s% T_start(k)
            s% xtra2_array(k) = T4m1%val - T400%val
            s% xtra3_array(k) = kap_face%val
            s% xtra4_array(k) = diff_T4_div_kap%val
            s% xtra5_array(k) = get_Lrad(s,k) 
            s% xtra6_array(k) = 1
         end subroutine set_xtras
   
   do mkx in star/test
   go back to dev_TDC_twin_studies and open inlist_common.  
      move the "debugging output" section to after the "standard output"
   open run_star_extras and go to subroutine data_for_extra_profile_columns
      edit the "debugging stuff" section as desired.
      for example, change to "if (.true.) then ! xtra arrays"
   mk;rn
   open inlist_star2 and save with pgstar pause = .true.
      change Profile_Panels1_xmax = 100 and save
      "hit RETURN to continue"
      note differences in log_etrb vs lgcv2_1 - don't have same conv_vel's at top edge of convection zone
      also differences in Y_face vs spr_ad_1 - don't have same dlnT/dlnP - grada at top edge.
      why? don't know.  the superadiabaticity started the same (at step 1), but has changed along with developing diff in L.
   
   ctrl-C stop the run after it has saved step 100 photos for star1 and star2
   open inlist_multi_stars_job
      restart_flag = .true.
      restart_names(1) = 'x100'
      restart_names(2) = 'x100'
   rn
      should get this terminal output at start
      restart_flag T
      restart_names           1 x100
      restart_names           2 x100
   
   check the plots for the xtras
   go back to run_star_extras and set "if (.true.) then ! debugging xtra differences"
   ctrl-C to stop; mk;rn to look at differences of xtras
   
   go back to run_star_extras and set "if (.true.) then ! debugging xtra ratios"
   ctrl-C to stop; mk;rn to look at "errors" of xtras
   
   

   
