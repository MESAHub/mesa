# This is the makefile for the mesa matrix library (a subset of lapack)

MESA_DIR = ../..

#################################################################
#
# PREAMBLE

include $(MESA_DIR)/utils/makefile_header

#################################################################
#
# SOURCES


LAPACK_QUAD_SRCS = \
   qgttrf.f \
   qgttrs.f \
   qgtts2.f \
   qgetrf.f \
   qgetrs.f \
   qgemv.f \
   qgemm.f \
   qgetf2.f \
   qswap.f \
   iqamax.f \
   qtrsm.f \
   qtrsv.f \
   qger.f \
   qscal.f \
   qlamch.f \
   qlaswp.f

MTX_SRCS = \
   mtx_def.f \
   my_lapack95_dble.f90 \
   my_lapack95_quad.f90 \
   mtx_support.f90 \
   DGBSVX_wrapper.f90 \
   pre_conditioners.f90 \
   bcyclic.f90 \
   mtx_lib.f90 \

ifneq ($(MAKECMDGOALS),clean)
   $(shell $(CPP) -DDBLE $(MOD_PRIVATE_DIR)/my_lapack95.F90 > my_lapack95_dble.f90)
   $(shell $(CPP)        $(MOD_PRIVATE_DIR)/my_lapack95.F90 > my_lapack95_quad.f90)
   # Alter the timestamps so make wont force a recompile just because we copied the files,
   # instead we only recompile if the original .F90 file was changed
   $(shell touch -r $(MOD_PRIVATE_DIR)/my_lapack95.F90 my_lapack95_dble.f90)
   $(shell touch -r $(MOD_PRIVATE_DIR)/my_lapack95.F90 my_lapack95_quad.f90)
endif

#################################################################
#
# TARGETS

MTX_LIB = libmtx.$(LIB_SUFFIX)

MTX_OBJS = $(patsubst %.f,%.o,$(patsubst %.f90,%.o,$(MTX_SRCS) $(LAPACK_QUAD_SRCS)))

all : $(MTX_LIB)

$(MTX_LIB) :$(MTX_OBJS)
ifneq ($(QUIET),)
	@echo LIB_TOOL $@
	@$(LIB_TOOL) $@ $(MTX_OBJS)
else
	$(LIB_TOOL) $@ $(MTX_OBJS)
endif 

clean:
	-@rm -f *.o *.f90 *.mod *genmod.f90 *.so *.a .depend *.smod

install:
	@$(CP_IF_NEWER) mtx_def.mod $(MESA_DIR)/include
	@$(CP_IF_NEWER) mtx_lib.mod $(MESA_DIR)/include
	@$(CP_IF_NEWER) ../public/mtx_*.dek $(MESA_DIR)/include
	@$(CP_IF_NEWER) ../public/mtx_*.inc $(MESA_DIR)/include
	@$(CP_IF_NEWER) $(MTX_LIB) $(MESA_DIR)/lib

nodeps : $(.DEFAULT_GOAL)

#################################################################
#
# COMPILATION RULES

CC += $(SPECIAL_C_FLAGS)

#COMPILE = $(COMPILE_TO_TEST) $(FCfixed)
COMPILE = $(COMPILE_TO_DEPLOY) $(FCfixed)
#COMPILE_FREE = $(COMPILE_TO_TEST) $(FCfree)
COMPILE_FREE = $(COMPILE_TO_DEPLOY) $(FCfree)

COMPILE_XTRA = $(COMPILE_BASIC) $(FCwarn) $(FCimpno) $(FCopt) -c $(FCfixed)
COMPILE_XTRA_NO_OPT = $(COMPILE_BASIC) $(FCnowarn) $(FCfixed) -c

COMPILE_CMD = $(COMPILE)

$(LAPACK_QUAD_OBJS) : COMPILE_CMD = $(COMPILE_XTRA) -w

%.o : %.mod

%.o : %.f
ifneq ($(QUIET),)
	@echo COMPILE_CMD $<
	@$(COMPILE_CMD) $<
else
	$(COMPILE_CMD) $<
endif

%.o : %.f90
ifneq ($(QUIET),)
	@echo COMPILE_FREE $<
	@$(COMPILE_FREE) $<
else
	$(COMPILE_FREE) $<
endif

%.mod : %.o
	@true

#################################################################
#
# DEPENDENCIES

SRC_PATH = $(MOD_PUBLIC_DIR):$(MOD_PRIVATE_DIR):../lapack_quad

vpath %.f $(SRC_PATH)
vpath %.f90 $(SRC_PATH)
vpath %.F90 $(SRC_PATH)
vpath %.dek $(SRC_PATH)

vpath %.mod $(MESA_DIR)/include

NODEPS = $(or $(filter nodeps,$(MAKECMDGOALS)),$(filter clean,$(MAKECMDGOALS)))

ifeq ($(NODEPS),)

  .depend :
  ifneq ($(QUIET),)
	@echo MAKEDEPF90
	@$(MAKEDEPF90) -I$(SRC_PATH) $(MTX_SRCS) > .depend
  else
	$(MAKEDEPF90) -I$(SRC_PATH) $(MTX_SRCS) > .depend
  endif

  -include .depend

endif
