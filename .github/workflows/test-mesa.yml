name: Test Mesa

on: [pull_request, release]

jobs:
  test_mesa:
    strategy:
      fail-fast: false

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      #- name: Install MESA on ${{ runner.os }} with SDK 23.7.3
      #  uses: ./.github/actions/install-mesa
      #  with:
      #    sdk: "23.7.3"
      # XXX    do_install: "false" # Skip install because mesa_test will do this

      - name: Checkout mesa_test
        uses: actions/checkout@v4
        with:
          repository: MESAHub/mesa_test
          path: mesa_test # Store in $GITHUB_WORKSPACE/mesa_test

      - name: Install mesa_test and create config file
        env:
          MESA_TEST_EMAIL: ${{ secrets.MESA_TEST_EMAIL }}
          MESA_TEST_PASSWORD: ${{ secrets.MESA_TEST_PASSWORD }}
          MESA_TEST_LOGS_TOKEN: ${{ secrets.MESA_TEST_LOGS_TOKEN }}
        run: |
          # Setup mesa_test
          cd $GITHUB_WORKSPACE/mesa_test
          sudo gem install mesa_test
          cd $GITHUB_WORKSPACE
          export OMP_NUM_THREADS=${{env.OMP_NUM_THREADS}}
          export NPROCS=${{env.NPROCS}}
          export MESASDK_ROOT=${{env.MESASDK_ROOT}}
          export MESA_DIR=${{env.MESA_DIR}}
          mkdir /home/runner/.mesa_test
          MESA_TEST_YML=/home/runner/.mesa_test/config.yml
          echo "---" > $MESA_TEST_YML
          echo "computer_name: GitHub_Runner" >> $MESA_TEST_YML
          echo "email: $MESA_TEST_EMAIL" >> $MESA_TEST_YML
          echo "password: $MESA_TEST_PASSWORD" >> $MESA_TEST_YML
          echo "logs_token: $MESA_TEST_LOGS_TOKEN" >> $MESA_TEST_YML
          echo "github_protocol: :ssh" >> $MESA_TEST_YML
          echo "mesa_mirror: $GITHUB_WORKSPACE/mirror" >> $MESA_TEST_YML
          echo "mesa_work: $GITHUB_WORKSPACE" >> $MESA_TEST_YML
          echo "platform: Linux" >> $MESA_TEST_YML
          echo "platform_version: Ubuntu" >> $MESA_TEST_YML
          # XXXsource "${MESASDK_ROOT}/bin/mesasdk_init.sh"
          echo "XXX"
          more $MESA_TEST_YML
          echo $MESA_TEST_EMAIL | sed 's/./& /g'
          # XXXmesa_test install --no-checkout
          mesa_test submit --empty
        shell: bash

      - name: Test Problem 13
        run: |
          # XXXmesa_test test 13
        shell: bash

      #- name: Test Problem 15
      #  run: |
      #    mesa_test test 15
      #  shell: bash
      #  
      #- name: Test Problem 29
      #  run: |
      #    mesa_test test 29
      #  shell: bash

      #- name: Test Problem 41
      #  run: |
      #    mesa_test test 41
      #  shell: bash
