---
name: 'install-mesa'

description: 'Download and install the MESA SDK and install MESA'

inputs:
  sdk:
    description: 'The version of the MESA SDK to install'
    required: false
    default: '25.12.1'


runs:

  using: 'composite'

  steps:
    - name: Install dependencies Linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get -y update
        sudo apt-get -y install wget binutils make perl libx11-6 libx11-dev zlib1g zlib1g-dev tcsh
        sudo apt-get -y autoremove
        sudo apt-get clean
      shell: bash

    - name: Install dependencies MacOS
      if: runner.os == 'macOS'
      run: |
        brew install --cask xquartz
        brew install gnu-sed
      shell: bash

    - name: Create LFS file list
      run: |
        git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id
      shell: bash

    - name: Restore LFS cache
      uses: actions/cache@v4
      id: lfs-cache
      with:
        path: .git/lfs
        key: ${{ runner.os }}-${{ hashFiles('.lfs-assets-id') }}-v1

    - name: Git LFS Pull
      run: git lfs pull
      shell: bash
      if: steps.lfs-cache.outputs.cache-hit != 'true'

    - name: Git LFS Checkout
      run: git lfs checkout
      shell: bash
      if: steps.lfs-cache.outputs.cache-hit == 'true'

    - uses: actions/cache@v4
      id: cache
      with:
        path: |
          mesasdk-x86_64-linux-${{inputs.sdk}}.tar.gz
        key: ${{ runner.os }}-${{inputs.sdk}}

    - name: Get SDK ${{ runner.os }} '25.12.1'
      if: ${{ (steps.cache.outputs.cache-hit != 'true') && (  inputs.sdk == '25.12.1') && (runner.os == 'Linux') }}
      run: |
        wget -q https://zenodo.org/records/18163992/files/mesasdk-x86_64-linux-25.12.1.tar.gz
      shell: bash

    - name: Unpack SDK ${{ runner.os }} ${{inputs.sdk}}
      if: runner.os == 'Linux'
      run: |
        tar xvf mesasdk-x86_64-linux-${{inputs.sdk}}.tar.gz
      shell: bash

    - name: Get SDK ${{ runner.os }} '25.12.1'
      if: ${{ (steps.cache.outputs.cache-hit != 'true') && (  inputs.sdk == '25.12.1') && (runner.os == 'macOS') }}
      run: |
        wget --user-agent="" -q http://user.astro.wisc.edu/~townsend/resource/download/mesasdk/mesasdk-aarch64-macos-25.12.1.pkg
      shell: bash

    - name: Unpack SDK ${{ runner.os }} ${{inputs.sdk}}
      if: runner.os == 'macOS'
      run: |
        sudo installer -pkg mesasdk-aarch64-macos-25.12.1.pkg -target /
        ln -s /Applications/mesasdk mesasdk
      shell: bash

    - name: Set MESA environment variables
      shell: bash
      run: |
        echo "MESASDK_ROOT=$(readlink -f mesasdk)" >> $GITHUB_ENV
        echo "MESA_DIR=$PWD" >> $GITHUB_ENV

    - name: Setup environment Linux
      shell: bash
      if: runner.os == 'Linux'
      run: |
        # Linux runners have 4 cores
        # https://docs.github.com/en/actions/reference/runners/github-hosted-runners#standard-github-hosted-runners-for-public-repositories
        echo "OMP_NUM_THREADS=4" >> $GITHUB_ENV
        echo "NPROCS=4" >> $GITHUB_ENV
        echo "SED=sed" >> $GITHUB_ENV

    - name: Setup environment MacOS
      shell: bash
      if: runner.os == 'macOS'
      run: |
        # MacOS runners have 3 cores
        # https://docs.github.com/en/actions/reference/runners/github-hosted-runners#standard-github-hosted-runners-for-public-repositories
        echo "OMP_NUM_THREADS=3" >> $GITHUB_ENV
        echo "NPROCS=3" >> $GITHUB_ENV
        echo "SED=gsed" >> $GITHUB_ENV

    - name: Compile
      run: |
        source "${MESASDK_ROOT}/bin/mesasdk_init.sh"
        # Everything is run as root so we need to disable the root check in the install script
        $SED -i 's/\${EUID:-\$(id -u)}/1/' install
        # Turn off caching during build to save more space
        $SED -i 's/use_cache_for_eos = .true./use_cache_for_eos = .false./g' $MESA_DIR/eos/public/eos_def.f90
        $SED -i 's/use_cache = .true./use_cache = .false./g' $MESA_DIR/star/private/star_private_def.f90
        ./install
      shell: bash
